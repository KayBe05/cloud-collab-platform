<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="description" content="CloudX Platform - Enterprise-grade cloud development environment">
  <meta name="theme-color" content="#0EA5E9">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <title>{% block title %}CloudX Platform v2.1{% endblock %}</title>

  <!-- Stylesheets -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  {% if request.path == '/settings' %}
  <link rel="stylesheet" href="{{ url_for('static', filename='settings.css') }}">
  {% endif %}
  <link rel="stylesheet" href="https://unpkg.com/@fortawesome/fontawesome-free@6.5.1/css/all.min.css">

  <!-- WebSocket & Chart Libraries -->
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"
    integrity="sha512-FBgHy/gvlKQCjvjLpYxJYT6ZZ5OPe/m0l0Y71ygSzVZ1nh8kVHWpIzlKy8G7NzQVxDzqb+jfkSz6pbkAhKe8A=="
    crossorigin="anonymous" referrerpolicy="no-referrer" defer></script>

  {% block extra_head %}{% endblock %}
</head>

<body>
  <!-- Navigation Sidebar -->
  <aside class="sidebar" role="navigation" aria-label="Main Navigation">
    <div class="sidebar-header">
      <div class="logo">
        <div class="logo-icon">
          <i class="fas fa-cloud"></i>
        </div>
        <div class="logo-text">
          <span class="logo-title">CloudX</span>
          <span class="logo-subtitle">Platform</span>
        </div>
      </div>
    </div>

    <nav class="sidebar-nav">
      <div class="nav-section">
        <span class="nav-section-title">Main</span>
        <a href="/" class="nav-item {% if request.path == '/' %}active{% endif %}">
          <i class="fas fa-home"></i>
          <span>Home</span>
        </a>
        <a href="/dashboard" class="nav-item {% if request.path == '/dashboard' %}active{% endif %}">
          <i class="fas fa-chart-line"></i>
          <span>Dashboard</span>
        </a>
        <a href="/projects" class="nav-item {% if request.path == '/projects' %}active{% endif %}">
          <i class="fas fa-folder"></i>
          <span>Projects</span>
          <span class="nav-badge">{{ stats.total_projects if stats else 0 }}</span>
        </a>
        <a href="/analytics" class="nav-item {% if request.path == '/analytics' %}active{% endif %}">
          <i class="fas fa-chart-bar"></i>
          <span>Analytics</span>
        </a>
      </div>

      <div class="nav-section">
        <span class="nav-section-title">Tools</span>
        <a href="http://localhost:8080" target="_blank" rel="noopener noreferrer" class="nav-item">
          <i class="fas fa-code"></i>
          <span>Code Editor</span>
          <i class="fas fa-external-link-alt nav-external"></i>
        </a>
        <a href="/dbtest" class="nav-item {% if request.path == '/dbtest' %}active{% endif %}">
          <i class="fas fa-database"></i>
          <span>Database</span>
        </a>
        <a href="/health" target="_blank" rel="noopener noreferrer" class="nav-item">
          <i class="fas fa-heartbeat"></i>
          <span>Health Check</span>
          <i class="fas fa-external-link-alt nav-external"></i>
        </a>
        <a href="/settings" class="nav-item {% if request.path == '/settings' %}active{% endif %}">
          <i class="fas fa-cog"></i>
          <span>Settings</span>
        </a>
      </div>
    </nav>

    <div class="sidebar-footer">
      <div class="system-status">
        <div class="status-indicator">
          <span class="status-dot"></span>
          <div class="status-info">
            <span class="status-title">System Status</span>
            <span class="status-text">All systems operational</span>
          </div>
        </div>
      </div>
      <div class="version-info">
        <span>Version 2.1.0</span>
      </div>
    </div>
  </aside>

  <!-- Main Content Area -->
  <main class="main-content" role="main">
    <!-- Top Header Bar -->
    <header class="top-header" role="banner">
      <div class="header-left">
        <button class="menu-toggle" id="menuToggle" aria-label="Toggle Navigation Menu">
          <i class="fas fa-bars"></i>
        </button>
        <div class="breadcrumb">
          {% block breadcrumb %}
          <i class="fas fa-home"></i>
          <i class="fas fa-chevron-right"></i>
          <span>Dashboard</span>
          {% endblock %}
        </div>
      </div>

      <div class="header-right">
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input type="text" placeholder="Search projects, files...">
        </div>

        <div class="connection-status" id="connectionStatus">
          <i class="fas fa-circle"></i>
          <span>Connected</span>
        </div>

        <button class="icon-button" title="Notifications">
          <i class="fas fa-bell"></i>
          <span class="notification-badge">3</span>
        </button>

        <div class="user-menu">
          <img src="https://ui-avatars.com/api/?name=User&background=0EA5E9&color=fff" alt="User Avatar"
            class="user-avatar">
        </div>
      </div>
    </header>

    <!-- Page Content -->
    <div class="content-wrapper">
      {% block content %}{% endblock %}
    </div>

    <!-- Footer -->
    <footer class="main-footer" role="contentinfo">
      <div class="footer-content">
        <p>&copy; 2026 CloudX Platform by Kritarth | Apache 2.0 License</p>
        <div class="footer-links">
          <a href="/health" target="_blank">API Health</a>
          <a href="https://github.com/KayBe05/cloud-collab-platform" target="_blank">GitHub</a>
          <a href="/analytics">System Status</a>
        </div>
      </div>
    </footer>
  </main>

  <!-- Toast Notification Container -->
  <div id="toastContainer" class="toast-container" role="region" aria-live="polite"></div>

  <!-- Base JavaScript -->
  <script>
    // Configuration
    const CONFIG = {
      socketTimeout: 60000,
      reconnectDelay: 1000,
      maxReconnectDelay: 30000,
      toastDuration: 3000
    };

    // WebSocket connection
    const socket = io({
      reconnection: true,
      reconnectionDelay: CONFIG.reconnectDelay,
      reconnectionDelayMax: CONFIG.maxReconnectDelay,
      reconnectionAttempts: 5
    });

    socket.on('connect', () => {
      console.log('Connected to CloudX Platform');
      updateConnectionStatus(true);
      showToast('Connected to CloudX Platform', 'success');
    });

    socket.on('disconnect', (reason) => {
      console.warn('Disconnected:', reason);
      updateConnectionStatus(false);
      if (reason !== 'io client namespace disconnect') {
        showToast('Disconnected from server', 'error');
      }
    });

    socket.on('connect_error', (error) => {
      console.error('Connection error:', error);
      updateConnectionStatus(false);
    });

    socket.on('connection_response', (data) => {
      console.log('Server response:', data);
    });

    socket.on('metrics_update', (metrics) => {
      console.log('Metrics received:', metrics);
      window.dispatchEvent(new CustomEvent('metricsUpdate', { detail: metrics }));
    });

    // Update connection status
    function updateConnectionStatus(connected) {
      const statusEl = document.getElementById('connectionStatus');
      if (!statusEl) return;

      if (connected) {
        statusEl.classList.remove('disconnected');
        statusEl.innerHTML = '<i class="fas fa-circle"></i><span>Connected</span>';
      } else {
        statusEl.classList.add('disconnected');
        statusEl.innerHTML = '<i class="fas fa-circle"></i><span>Disconnected</span>';
      }
    }

    // Toast notifications
    function showToast(message, type = 'info', duration = CONFIG.toastDuration) {
      const container = document.getElementById('toastContainer');
      if (!container) return;

      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;

      const iconMap = {
        'success': 'check-circle',
        'error': 'exclamation-circle',
        'warning': 'exclamation-triangle',
        'info': 'info-circle'
      };

      const icon = iconMap[type] || 'info-circle';

      toast.innerHTML = `
        <i class="fas fa-${icon}"></i>
        <span>${escapeHtml(message)}</span>
        <button class="toast-close" onclick="this.parentElement.remove()">
          <i class="fas fa-times"></i>
        </button>
      `;

      container.appendChild(toast);

      requestAnimationFrame(() => {
        toast.classList.add('show');
      });

      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, duration);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Sidebar toggle for mobile
    const menuToggle = document.getElementById('menuToggle');
    const sidebar = document.querySelector('.sidebar');

    if (menuToggle) {
      menuToggle.addEventListener('click', (e) => {
        e.stopPropagation();
        sidebar.classList.toggle('mobile-open');
      });
    }

    // Close sidebar on mobile when clicking outside
    document.querySelector('.main-content')?.addEventListener('click', () => {
      if (window.innerWidth <= 768 && sidebar?.classList.contains('mobile-open')) {
        sidebar.classList.remove('mobile-open');
      }
    });

    // Handle window resize
    window.addEventListener('resize', () => {
      if (window.innerWidth > 768) {
        sidebar?.classList.remove('mobile-open');
      }
    });

    // Keyboard accessibility
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && sidebar?.classList.contains('mobile-open')) {
        sidebar.classList.remove('mobile-open');
      }
    });
  </script>

  {% block scripts %}{% endblock %}
</body>

</html>